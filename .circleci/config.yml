version: 2.1

orbs:
  python: circleci/python@1.2
  heroku: circleci/heroku@0.0.10

workflows:
  flask-app-deploy-and-test:
      jobs:
        - heroku/deploy-via-git:
            filters:
              branches:
                only: master
        - test:
            requires:
              - heroku/deploy-via-git
jobs:
  test:
      docker:
      - image: cimg/python:3.9
      steps:
        - checkout
        - python/install-packages:
            pkg-manager: pip
        - run:
            name: Install chromedriver
            command: |
              sudo apt update
              sudo apt-get install -y chromium-chromedriver
              sudo apt-get install -y chromium-browser
              ./chromedriver
              sudo apt-get install -y libglib2.0-0 libnss3 libgconf-2-4 libfontcongfig1
              chromedriver --version
              chromium-browser --version
        - run:
            name: Run behave tests
            command: |
              cd test/features
              behave -D url=https://flask-circleci-epo.herokuapp.com/

